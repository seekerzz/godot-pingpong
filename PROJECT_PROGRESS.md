# Godot 传感器数据传输与 3D 可视化项目 - 进度文档

**最后更新**: 2026-02-15

---

## 项目概述

本项目实现了一套完整的手机传感器数据采集、传输、录制和 3D 可视化系统。

- **手机端**: Godot 4.3 Android 应用，采集传感器数据并通过 UDP 发送到电脑
- **电脑端**: Godot 4.3 PC 应用，接收数据并显示 3D 轨迹可视化

---

## 功能清单

### 手机端功能 (godot_client/)

#### 1. 实时数据传输
- 采集加速度计、陀螺仪、重力传感器、磁力计数据
- 通过 UDP 协议发送到电脑端 (IP: 192.168.50.64, 端口: 49555)
- 发送频率: 20Hz (每 50ms 一帧)

#### 2. 录制功能
- 点击"开始录制"按钮开始记录传感器数据
- 点击"结束录制"保存到本地文件
- 文件命名格式: `record_YYYYMMDD_HHMMSS.json`
- 文件内容包括:
  - 录制日期时间
  - 帧数统计
  - 录制时长
  - 所有传感器帧数据

#### 3. 录制回放
- 列表显示所有已保存的录制文件
- 选择录制文件后点击"开始回放"
- 数据通过 UDP 发送到电脑端重新播放
- 显示回放进度条
- 支持删除不需要的录制文件

#### 4. UI 界面
- 实时显示传感器数值
- 录制状态指示
- 录制列表管理
- 回放控制按钮

---

### 电脑端功能 (godot_server/)

#### 1. 实时接收与可视化
- UDP 服务器监听端口 49555
- 3D 手机模型实时旋转和位置更新
- 运动轨迹记录和显示
- 地面网格参考

#### 2. 录制数据接收
- 接收手机端实时录制数据
- 保存到本地文件
- 接收回放数据并缓存

#### 3. 本地回放与调试
- **L 键**: 加载最新的录制文件
- **P 键**: 开始/停止本地回放
- **S 键**: 保存接收到的回放数据
- 逐帧回放便于调试算法

#### 4. 3D 场景控制
- **R 键**: 重置视角和位置
- **C 键**: 清除轨迹
- **ESC 键**: 退出程序

---

## 文件结构

```
godot_pingpong/
├── godot_client/                    # 手机端项目
│   ├── sensor_sender.gd            # 主脚本: 传感器采集、录制、回放
│   ├── main.tscn                   # 主场景: UI 布局
│   ├── export_presets.cfg          # Android 导出配置
│   ├── debug.keystore              # Android 调试签名
│   ├── sensor_display.apk          # 编译好的 APK (24MB)
│   └── android/                     # Android 构建模板
│       └── build/
│
├── godot_server/                    # 电脑端项目
│   ├── sensor_server.gd            # 主脚本: 数据接收、3D 可视化、回放
│   ├── main.tscn                   # 主场景: 3D 场景和 UI
│   └── phone_visualizer.gd         # 手机模型可视化脚本
│
└── PROJECT_PROGRESS.md             # 本文件
```

---

## 数据格式

### 实时传感器数据
```json
{
  "accel": {"x": 0.123, "y": 0.456, "z": 9.801},
  "gyro": {"x": 0.001, "y": -0.002, "z": 0.003},
  "gravity": {"x": 0.0, "y": 0.0, "z": 9.8},
  "magneto": {"x": 25.3, "y": 12.1, "z": -40.2},
  "timestamp": 1771149060.511,
  "recorded": false
}
```

### 录制文件格式
```json
{
  "record_date": "2024-02-15 14:30:25",
  "frame_count": 200,
  "duration": 10.0,
  "frames": [
    {
      "accel": {"x": 0.123, "y": 0.456, "z": 9.801},
      "gyro": {"x": 0.001, "y": -0.002, "z": 0.003},
      "gravity": {"x": 0.0, "y": 0.0, "z": 9.8},
      "magneto": {"x": 25.3, "y": 12.1, "z": -40.2},
      "timestamp": 1771149060.511,
      "recorded": true
    },
    ...
  ]
}
```

### 标记消息类型
- `record_start`: 开始录制标记
- `record_stop`: 结束录制标记
- `playback_start`: 开始回放标记 (含文件名和帧数)
- `playback_stop`: 停止回放标记

---

## 使用方法

### 手机端

1. **实时传输**
   - 打开应用，确保手机和电脑在同一 WiFi
   - 应用会自动发送传感器数据到电脑

2. **录制动作**
   - 点击"开始录制"按钮
   - 执行动作
   - 点击"结束录制"按钮保存

3. **回放录制**
   - 从列表中选择一个录制文件
   - 点击"开始回放"发送到电脑
   - 或点击"删除"移除不需要的文件

### 电脑端

1. **启动服务器**
   - 运行 Godot 项目
   - 服务器自动启动并监听端口 49555

2. **接收数据**
   - 自动接收手机实时数据或回放数据
   - 3D 模型会实时更新

3. **回放调试**
   - 按 **L** 加载本地录制文件
   - 按 **P** 开始/停止回放
   - 按 **S** 保存接收到的回放数据
   - 按 **R** 重置视角
   - 按 **C** 清除轨迹

---

## Git 提交历史

```
godot_client:
- f6db5d8 Add recording playback system
- 4197649 Rollback pairing system, keep recording feature

godot_server:
- 8ae32e2 Add recording playback and debugging system
- 37b3992 Rollback pairing system, keep recording feature
```

---

## 已知问题

1. **APK 导出**: 需要使用 `--export-debug` 并手动签名
2. **网络连接**: 需要手机和电脑在同一局域网
3. **轨迹漂移**: 当前算法存在积分漂移问题，需要后续优化

---

## 下一步计划

- [ ] 优化轨迹算法，减少漂移误差
- [ ] 添加更多滤波算法（卡尔曼滤波）
- [ ] 支持多段录制拼接
- [ ] 添加录制文件导出/分享功能
- [ ] 电脑端添加录制文件列表 UI

---

## 技术栈

- **引擎**: Godot 4.3
- **语言**: GDScript
- **网络**: UDP (PacketPeerUDP)
- **平台**: Android (手机端), Windows (电脑端)
- **数据格式**: JSON

---

## 网络配置

- **电脑 IP**: 192.168.50.64
- **端口**: 49555 (固定)
- **协议**: UDP

---

*文档结束*
